<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
	<table class="table table-striped">
		<thead>
			<th><a href="#" class="btn btn-sm btn-primary" id="submitButton">Send</a></th>
			<th>Runner 1</th>
			<th>Runner 2</th>
			<th>Runner 3</th>
			<th>Runner 4</th>
		</thead>
		<tbody>
			<tr>
				<td>
					<span>Pseudo:</span>
				</td>
				<td>
					<input id="runnerId_1" type="text" placeholder="pseudo"/>
				</td>
				<td>
					<input id="runnerId_2" type="text" placeholder="pseudo"/>
				</td>
				<td>
					<input id="runnerId_3" type="text" placeholder="pseudo"/>
				</td>
				<td>
					<input id="runnerId_4" type="text" placeholder="pseudo"/>
				</td>
			</tr>
			<tr>
				<td>
					<span>Light PB:</span>
				</td>
				<td>
					<span id="runnerLightScore_1"></span>
					(<span id="runnerLightTime_1"></span>)
				</td>
				<td>
					<span id="runnerLightScore_2"></span>
					(<span id="runnerLightTime_2"></span>)
				</td>
				<td>
					<span id="runnerLightScore_3"></span>
					(<span id="runnerLightTime_3"></span>)
				</td>
				<td>
					<span id="runnerLightScore_4"></span>
					(<span id="runnerLightTime_4"></span>)
				</td>
			</tr>
			<tr>
				<td>
					<span>Dark PB:</span>
				</td>
				<td>
					<span id="runnerDarkScore_1"></span>
					(<span id="runnerDarkTime_1"></span>)
				</td>
				<td>
					<span id="runnerDarkScore_2"></span>
					(<span id="runnerDarkTime_2"></span>)
				</td>
				<td>
					<span id="runnerDarkScore_3"></span>
					(<span id="runnerDarkTime_3"></span>)
				</td>
				<td>
					<span id="runnerDarkScore_4"></span>
					(<span id="runnerDarkTime_4"></span>)
				</td>
			</tr>
		<tr>
			<td>&nbsp;</td>
			<td>
				<button class="btn btn-sm btn-success loadRtmp" data-player="1" id="loadRtmp_1">Load</button>
				<button class="btn btn-sm btn-primary" id="showCard_1">Card</button>
			</td>
			<td>
				<button class="btn btn-sm btn-success loadRtmp" data-player="2" id="loadRtmp_2">Load</button>
				<button class="btn btn-sm btn-primary" id="showCard_2">Card</button>
			</td>
			<td>
				<button class="btn btn-sm btn-success loadRtmp" data-player="3" id="loadRtmp_3">Load</button>
				<button class="btn btn-sm btn-primary" id="showCard_3">Card</button>
			</td>
			<td>
				<button class="btn btn-sm btn-success loadRtmp" data-player="4" id="loadRtmp_4">Load</button>
				<button class="btn btn-sm btn-primary" id="showCard_4">Card</button>
			</td>
		</tr>
		</tbody>
	</table>

	<a href="#" class="btn btn-sm btn-danger" id="hideCardsButton">Hide cards</a>


	<button class="btn btn-sm btn-primary" id="fetchPbButton">Update <span id="currentGame"></span> (<span id="currentSeason"></span>) PBs</button>
</body>

<script>
	const runnerId_1 = document.querySelector('#runnerId_1');
	const runnerId_2 = document.querySelector('#runnerId_2');
	const runnerId_3 = document.querySelector('#runnerId_3');
	const runnerId_4 = document.querySelector('#runnerId_4');

	const showCard_1 = document.querySelector('#showCard_1');
	const showCard_2 = document.querySelector('#showCard_2');
	const showCard_3 = document.querySelector('#showCard_3');
	const showCard_4 = document.querySelector('#showCard_4');
	const hideCardsButton = document.querySelector('#hideCardsButton');

	const loadRtmp_1 = document.querySelector('#loadRtmp_1');
	const loadRtmp_2 = document.querySelector('#loadRtmp_2');
	const loadRtmp_3 = document.querySelector('#loadRtmp_3');
	const loadRtmp_4 = document.querySelector('#loadRtmp_4');

	const season = nodecg.Replicant('season');
	const game = nodecg.Replicant('game');

	loadRtmp_1.onclick = () => {
		nodecg.sendMessage(
			'loadRTMP',
			{
				id: 1,
				runner: runnerId_1.value,
			}
		);
	};
	loadRtmp_2.onclick = () => {
		nodecg.sendMessage(
			'loadRTMP',
			{
				id: 2,
				runner: runnerId_2.value,
			}
		);
	};
	loadRtmp_3.onclick = () => {
		nodecg.sendMessage(
			'loadRTMP',
			{
				id: 3,
				runner: runnerId_3.value,
			}
		);
	};
	loadRtmp_4.onclick = () => {
		nodecg.sendMessage(
			'loadRTMP',
			{
				id: 4,
				runner: runnerId_4.value,
			}
		);
	};

	showCard_1.onclick = () => {
		nodecg.sendMessage(
			'showCard',
			{
				runner: runnerId_1.value,
				season: season.value,
			}
		);
	};

	showCard_2.onclick = () => {
		nodecg.sendMessage(
			'showCard',
			{
				runner: runnerId_2.value,
				season: season.value,
			}
		);
	};

	showCard_3.onclick = () => {
		nodecg.sendMessage(
			'showCard',
			{
				runner: runnerId_3.value,
				season: season.value,
			}
		);
	};

	showCard_4.onclick = () => {
		nodecg.sendMessage(
			'showCard',
			{
				runner: runnerId_4.value,
				season: season.value,
			}
		);
	};

	hideCardsButton.onclick = () => {
		nodecg.sendMessage(
			'hideCard',
			false
		);
	};

	const runnerLightScore_1 = document.querySelector('#runnerLightScore_1');
	const runnerLightScore_2 = document.querySelector('#runnerLightScore_2');
	const runnerLightScore_3 = document.querySelector('#runnerLightScore_3');
	const runnerLightScore_4 = document.querySelector('#runnerLightScore_4');

	const runnerLightTime_1 = document.querySelector('#runnerLightTime_1');
	const runnerLightTime_2 = document.querySelector('#runnerLightTime_2');
	const runnerLightTime_3 = document.querySelector('#runnerLightTime_3');
	const runnerLightTime_4 = document.querySelector('#runnerLightTime_4');

	const runnerDarkScore_1 = document.querySelector('#runnerDarkScore_1');
	const runnerDarkScore_2 = document.querySelector('#runnerDarkScore_2');
	const runnerDarkScore_3 = document.querySelector('#runnerDarkScore_3');
	const runnerDarkScore_4 = document.querySelector('#runnerDarkScore_4');

	const runnerDarkTime_1 = document.querySelector('#runnerDarkTime_1');
	const runnerDarkTime_2 = document.querySelector('#runnerDarkTime_2');
	const runnerDarkTime_3 = document.querySelector('#runnerDarkTime_3');
	const runnerDarkTime_4 = document.querySelector('#runnerDarkTime_4');

	const submitButton = document.querySelector('#submitButton');

	const runnerIdReplicant_1 = nodecg.Replicant('runnerId_1');
	const runnerIdReplicant_2 = nodecg.Replicant('runnerId_2');
	const runnerIdReplicant_3 = nodecg.Replicant('runnerId_3');
	const runnerIdReplicant_4 = nodecg.Replicant('runnerId_4');

	const runnerLightScoreReplicant_1 = nodecg.Replicant('runnerLightScore_1');
	const runnerLightScoreReplicant_2 = nodecg.Replicant('runnerLightScore_2');
	const runnerLightScoreReplicant_3 = nodecg.Replicant('runnerLightScore_3');
	const runnerLightScoreReplicant_4 = nodecg.Replicant('runnerLightScore_4');

	const runnerLightTimeReplicant_1 = nodecg.Replicant('runnerLightTime_1');
	const runnerLightTimeReplicant_2 = nodecg.Replicant('runnerLightTime_2');
	const runnerLightTimeReplicant_3 = nodecg.Replicant('runnerLightTime_3');
	const runnerLightTimeReplicant_4 = nodecg.Replicant('runnerLightTime_4');

	const runnerDarkScoreReplicant_1 = nodecg.Replicant('runnerDarkScore_1');
	const runnerDarkScoreReplicant_2 = nodecg.Replicant('runnerDarkScore_2');
	const runnerDarkScoreReplicant_3 = nodecg.Replicant('runnerDarkScore_3');
	const runnerDarkScoreReplicant_4 = nodecg.Replicant('runnerDarkScore_4');

	const runnerDarkTimeReplicant_1 = nodecg.Replicant('runnerDarkTime_1');
	const runnerDarkTimeReplicant_2 = nodecg.Replicant('runnerDarkTime_2');
	const runnerDarkTimeReplicant_3 = nodecg.Replicant('runnerDarkTime_3');
	const runnerDarkTimeReplicant_4 = nodecg.Replicant('runnerDarkTime_4');

	for (let i = 1; i <= 4; i++) {
		eval('runnerIdReplicant_' + i).on('change', (newValue) => {
			eval('runnerId_' + i).value = newValue;
		});

		eval('runnerLightScoreReplicant_' + i).on('change', (newValue) => {
			eval('runnerLightScore_' + i).innerHTML = newValue;
		});
		eval('runnerLightTimeReplicant_' + i).on('change', (newValue) => {
			eval('runnerLightTime_' + i).innerHTML = newValue;
		});
		eval('runnerDarkScoreReplicant_' + i).on('change', (newValue) => {
			eval('runnerDarkScore_' + i).innerHTML = newValue;
		});
		eval('runnerDarkTimeReplicant_' + i).on('change', (newValue) => {
			eval('runnerDarkTime_' + i).innerHTML = newValue;
		});
	}

	submitButton.onclick = () => {
		for (let i = 1; i <= 4; i++) {
			nodecg.sendMessage(
				'updateUser-' + i,
				{
					player: eval('runnerId_' + i).value,
					light: {
						score: eval('runnerLightScore_' + i).innerHTML,
						time: eval('runnerLightTime_' + i).innerHTML,
					},
					dark: {
						score: eval('runnerDarkScore_' + i).innerHTML,
						time: eval('runnerDarkTime_' + i).innerHTML,
					}
				}
			);

			eval('runnerIdReplicant_' + i).value = eval('runnerId_' + i).value;
			eval('runnerLightScoreReplicant_' + i).value = eval('runnerLightScore_' + i).value;
			eval('runnerLightTimeReplicant_' + i).value = eval('runnerLightTime_' + i).value;
			eval('runnerDarkScoreReplicant_' + i).value = eval('runnerDarkScore_' + i).value;
			eval('runnerDarkTimeReplicant_' + i).value = eval('runnerDarkTime_' + i).value;
		}
	};


	//[FETCH PB]
	const currentSeason = document.querySelector('#currentSeason');
	season.on('change', (newSeason) => {
		currentSeason.innerHTML = newSeason;
	});

	const currentGame = document.querySelector('#currentGame');
	game.on('change', (newGame) => {
		currentGame.innerHTML = newGame;
	});

	const fetchPbButton = document.querySelector('#fetchPbButton');
	fetchPbButton.onclick = () => {
		nodecg.sendMessage(
			'fetchPBList',
			{
				players : {
					1: runnerId_1.value,
					2: runnerId_2.value,
					3: runnerId_3.value,
					4: runnerId_4.value,
				},
				game: game.value,
				season: season.value
			}
		);
	};

	const fetchPbListReplicant = nodecg.Replicant('fetchPbList');
	fetchPbListReplicant.on('change', (newValue) => {
		if (!newValue) {
			return;
		}

		for (const [key, infos] of Object.entries(newValue)) {
			let lightScore = 'runnerLightScore_' + key;
			let lightTime = 'runnerLightTime_' + key;
			let darkScore = 'runnerDarkScore_' + key;
			let darkTime = 'runnerDarkTime_' + key;

			eval(lightScore).innerHTML = infos.light.score;
			eval(lightTime).innerHTML = new Date(infos.light.time * 1000).toISOString().substr(11, 8);
			eval(darkScore).innerHTML = infos.dark.score;
			eval(darkTime).innerHTML = new Date(infos.dark.time * 1000).toISOString().substr(11, 8);
		}
	});
</script>
</html>
