<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="css/global.css">
	<link rel="stylesheet" href="css/chrono.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;1,300&display=swap"
		rel="stylesheet"
	/>
</head>

<body>
<div class="container">
	<video autoplay muted id="chronoVid">
		<source src="/assets/UD/ud-utils/chrono.webm" type="video/webm">
	</video>
	<div id="chronoInfos">
		<div class="infos" id="chrono"></div>
		<div class="infos" id="score"></div>
	</div>
</div>
<script>
	const chrono = document.querySelector('#chrono');
	const scoreSpan = document.querySelector('#score');
	const chronoVid = document.querySelector('#chronoVid');

	// Convert time to a format of hours, minutes, seconds, and milliseconds
	function timeToString(time) {
		let diffInHrs = time / 3600000;
		let hh = Math.floor(diffInHrs);

		let diffInMin = (diffInHrs - hh) * 60;
		let mm = Math.floor(diffInMin);
		if (currentMinute !== mm) {
			currentMinute = mm;
			chronoVid.play();
		}

		let diffInSec = (diffInMin - mm) * 60;
		let ss = Math.floor(diffInSec);

		let formattedHH = hh.toString().padStart(2, "0");
		let formattedMM = mm.toString().padStart(2, "0");
		let formattedSS = ss.toString().padStart(2, "0");

		return `${formattedHH}:${formattedMM}:${formattedSS}`;
	}

	// Declare variables to use in our functions below
	let startTime;
	let elapsedTime = 0;
	let currentMinute = 0;
	let timerInterval;

	// Create function to modify innerHTML
	function print(txt) {
		chrono.innerHTML = txt;
	}

	// Create "start", "pause" and "reset" functions
	function start() {
		startTime = Date.now() - elapsedTime;
		timerInterval = setInterval(function printTime() {
			elapsedTime = Date.now() - startTime;
			print(timeToString(elapsedTime));
			updateScore(elapsedTime);
		}, 10);
	}

	function pause() {
		clearInterval(timerInterval);
	}

	function reset() {
		clearInterval(timerInterval);
		print("");
		scoreSpan.innerHTML = "";
		elapsedTime = 0;
		currentMinute = 0;
	}

	nodecg.listenFor('startTimer', async gameInfos => {
		reset();
		chrono.dataset.bestTime = gameInfos.bestTime;
		chrono.dataset.middleTime = gameInfos.middleTime;
		chrono.dataset.minScore = gameInfos.minScore;
		chrono.dataset.maxScore = gameInfos.maxScore;

		start();
	});

	nodecg.listenFor('stopTimer', async query => {
		reset();
	});

	function updateScore(time) {
		let timeInSec = time/1000;
		let score = calcScore(
			timeInSec,
			chrono.dataset.bestTime,
			chrono.dataset.middleTime,
			chrono.dataset.minScore,
			chrono.dataset.maxScore,
			208
		);

		if (String(score) !== scoreSpan.innerHTML) {
			scoreSpan.innerHTML = String(score);
		}
	}

	function calcScore(time, bestTime, middleTime, minScore, maxScore, capGame) {
		time = parseInt(time);
		bestTime = parseInt(bestTime);
		middleTime = parseInt(middleTime);
		let timeCoeff = 2;

		let totalDiffTime = bestTime - (bestTime + ((middleTime - bestTime) *2))

		let score = Math.min(
			capGame,
			Math.max(
				Math.floor(
					100 * (timeCoeff - (((bestTime - time) / totalDiffTime) * timeCoeff))
				),
				0
			)
		);

		if (score < 100) {
			let diffBetweenHundedAndTwoHundred = middleTime - bestTime;
			let p_high = 100 / (Math.pow(2, Math.floor((time - middleTime)/diffBetweenHundedAndTwoHundred)));

			score = Math.floor(p_high-(p_high/2)*(((time - middleTime)/diffBetweenHundedAndTwoHundred) - Math.floor((time - middleTime)/diffBetweenHundedAndTwoHundred)));
		}

		if ('' !== minScore && score < parseInt(minScore)) {
			score = 0;
		}
		if (maxScore) {
			score = Math.min(score, parseInt(maxScore));
		}

		return score;
	}
</script>
</body>
</html>
