<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container">
	<form class="row g-3">
		<div class="col-md-6">
			<label for="seasonInput" class="form-label">Season :</label>
			<input class="form-control" type="number" id="seasonInput" placeholder="seasonId"/>
			<button class="btn btn-primary" id="fetchGamesButton">Fetch Games</button>
		</div>
		<div class="col-md-6">
			<label for="gameSelect" class="form-label">Game :</label>
			<select class="form-control form-select form-select-sm" name="gameSelect" id="gameSelect"></select>
		</div>
		<div class="col-6">
			<label for="gameName" class="form-label">Name</label>
			<input disabled type="text" class="form-control" id="gameName">
		</div>
		<div class="col-md-4">
			<label for="gameColor" class="form-label">Color</label>
			<input disabled type="text" class="form-control" id="gameColor">
		</div>
		<div class="col-md-2">
			<svg id= "gameSvg" data-width="1000" viewBox="0,0,1000,1000" height="75" width="75">
				<path id="gameSvgPath" d=""/>
			</svg>
		</div>
		<div class="col-6">
			<label for="gameCategoryLight" class="form-label">Category light</label>
			<input disabled type="text" class="form-control" id="gameCategoryLight">
		</div>
		<div class="col-6">
			<label for="gameCategoryDark" class="form-label">Category dark</label>
			<input disabled type="text" class="form-control" id="gameCategoryDark">
		</div>
		<div class="col-md-12">
			<table class="table">
				<tbody>
				<tr>
					<th>&nbsp;</th>
					<th>200 pts</th>
					<th>100 pts</th>
					<th>0 pts</th>
					<th>min</th>
					<th>max</th>
				</tr>
				</tbody>
				<tbody>
				<tr>
					<td>LIGHT</td>
					<td><input disabled type="text" class="form-control" id="gameMaxTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMidTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameFewTimeLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMinScoreLight"></td>
					<td><input disabled type="text" class="form-control" id="gameMaxScoreLight"></td>
				</tr>
				<tr>
					<td>DARK</td>
					<td><input disabled type="text" class="form-control" id="gameMaxTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMidTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameFewTimeDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMinScoreDark"></td>
					<td><input disabled type="text" class="form-control" id="gameMaxScoreDark"></td>
				</tr>
				</tbody>
			</table>
		</div>
		<div class="col-md-6">
			<a class="btn btn-light" id="sendLight">Send light</a>
			<a class="btn btn-success" id="startLight">Start</a>
			<a class="btn btn-danger" id="stopLight">Stop</a>
		</div>
		<div class="col-md-6">
			<a class="btn btn-dark" id="sendDark">Send dark</a>
			<a class="btn btn-success" id="startDark">Start</a>
			<a class="btn btn-danger" id="stopDark">Stop</a>
		</div>
	</form>

</div>
</body>

<script>
	const gameSelect = document.querySelector('#gameSelect');
	const seasonInput = document.querySelector('#seasonInput');
	const fetchGamesButton = document.querySelector('#fetchGamesButton');
	const sendLight = document.querySelector('#sendLight');
	const sendDark = document.querySelector('#sendDark');

	const startLight = document.querySelector('#startLight');
	const stopLight = document.querySelector('#stopLight');

	const startDark = document.querySelector('#startDark');
	const stopDark = document.querySelector('#stopDark');

	const gameName = document.querySelector('#gameName');
	const gameColor = document.querySelector('#gameColor');
	const gameSvg = document.querySelector('#gameSvg');
	const gameSvgPath = document.querySelector('#gameSvgPath');
	const gameCategoryLight = document.querySelector('#gameCategoryLight');
	const gameCategoryDark = document.querySelector('#gameCategoryDark');
	const gameMaxTimeLight = document.querySelector('#gameMaxTimeLight');
	const gameMidTimeLight = document.querySelector('#gameMidTimeLight');
	const gameFewTimeLight = document.querySelector('#gameFewTimeLight');
	const gameMaxTimeDark = document.querySelector('#gameMaxTimeDark');
	const gameMidTimeDark = document.querySelector('#gameMidTimeDark');
	const gameFewTimeDark = document.querySelector('#gameFewTimeDark');
	const gameMinScoreLight = document.querySelector('#gameMinScoreLight');
	const gameMaxScoreLight = document.querySelector('#gameMaxScoreLight');
	const gameMinScoreDark = document.querySelector('#gameMinScoreDark');
	const gameMaxScoreDark = document.querySelector('#gameMaxScoreDark');

	const season = nodecg.Replicant('season');
	const game = nodecg.Replicant('game');

	fetchGamesButton.onclick = () => {
		nodecg.sendMessage(
			'fetchGamesList',
			seasonInput.value
		);
	};

	startLight.onclick = () => {
		nodecg.sendMessage(
			'startTimer',
			{
				bestTime: gameMaxTimeLight.dataset.seconds,
				middleTime: gameMidTimeLight.dataset.seconds,
				minScore: gameMinScoreLight.value,
				maxScore: gameMaxScoreLight.value,
			}
		);
	};

	stopLight.onclick = () => {
		nodecg.sendMessage('stopTimer');
	};

	startDark.onclick = () => {
		nodecg.sendMessage(
			'startTimer',
			{
				bestTime: gameMaxTimeDark.dataset.seconds,
				middleTime: gameMidTimeDark.dataset.seconds,
				minScore: gameMinScoreDark.value,
				maxScore: gameMaxScoreDark.value,
			}
		);
	};

	stopDark.onclick = () => {
		nodecg.sendMessage('stopTimer');
	};

	sendLight.onclick = () => {
		nodecg.sendMessage(
			'sendGameInfos',
			{
				name: gameName.value,
				category: gameCategoryLight.value,
				path: gameSvgPath.getAttribute('d'),
				width: gameSvg.dataset.width,
			}
		);
	};

	sendDark.onclick = () => {
		nodecg.sendMessage(
			'sendGameInfos',
			{
				name: gameName.value,
				category: gameCategoryDark.value,
				path: gameSvgPath.getAttribute('d'),
				width: gameSvg.dataset.width,
			}
		);
	};

	season.on('change', () => {
		seasonInput.value = season.value;
	});

	gameSelect.onchange = () => {
		game.value = gameSelect.value;

		nodecg.sendMessage(
			'getGameInfos',
			{
				season: seasonInput.value,
				game: gameSelect.value
			},
		);
	}

	const fetchGamesListReplicant = nodecg.Replicant('fetchGamesList');
	fetchGamesListReplicant.on('change', (newValue) => {
		if (!newValue) {
			return;
		}

		//First, we clear the old games list.
		var length = gameSelect.options.length;
		for (let i = length-1; i >= 0; i--) {
			gameSelect.options[i].remove();
		}

		//Then we add the new one.
		for (let i = 0; i < newValue.length; i++) {
			let game = document.createElement("option");
			game.value = newValue[i];
			game.text = newValue[i];

			gameSelect.add(game);
		}

		season.value = seasonInput.value;
		gameSelect.onchange();
	});

	const gameInfos = nodecg.Replicant('getGameInfos');
	gameInfos.on('change', (infos) => {
		if (!infos) {
			return;
		}

		gameName.value = infos.name;
		gameColor.value = infos.hexColor;
		gameSvg.setAttribute('viewBox', '0,0,' + infos.pathInformation.width + ',' + infos.pathInformation.width);
		gameSvg.dataset.width = infos.pathInformation.width;
		gameSvgPath.setAttribute('d', infos.pathInformation.path);

		gameCategoryLight.value = infos.light.category;
		gameCategoryDark.value = infos.dark.category;


		gameMinScoreLight.value = infos.light.minScore ?? '';
		gameMaxScoreLight.value = infos.light.maxScore ?? '';
		gameMinScoreDark.value = infos.dark.minScore ?? '';
		gameMaxScoreDark.value = infos.dark.maxScore ?? '';

		gameMaxTimeLight.value = new Date(infos.light.bestTime * 1000).toISOString().substr(11, 8);
		gameMaxTimeLight.dataset.seconds = infos.light.bestTime;
		gameMidTimeLight.value = new Date(infos.light.middleTime * 1000).toISOString().substr(11, 8);
		gameMidTimeLight.dataset.seconds = infos.light.middleTime;
		gameFewTimeLight.value = new Date(infos.light.fewestTime * 1000).toISOString().substr(11, 8);
		gameFewTimeLight.dataset.seconds = infos.light.fewestTime;

		gameMaxTimeDark.value = new Date(infos.dark.bestTime * 1000).toISOString().substr(11, 8);
		gameMaxTimeDark.dataset.seconds = infos.dark.bestTime;
		gameMidTimeDark.value = new Date(infos.dark.middleTime * 1000).toISOString().substr(11, 8);
		gameMidTimeDark.dataset.seconds = infos.dark.middleTime;
		gameFewTimeDark.value = new Date(infos.dark.fewestTime * 1000).toISOString().substr(11, 8);
		gameFewTimeDark.dataset.seconds = infos.dark.fewestTime;
	});
</script>
</html>
